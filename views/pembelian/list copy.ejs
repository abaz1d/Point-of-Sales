<%- include('../partials/header') %>
	<!-- ============================================================== -->
	<!-- Start right Content here -->
	<!-- ============================================================== -->
	<div class="main-content">
		<div class="page-content">
			<div class="container-fluid">
				<!-- start page title -->
				<div class="row">
					<div class="col-12">
						<div class="page-title-box d-sm-flex align-items-center justify-content-between">
							<h4 class="mb-sm-0 font-size-18">PENJUALAN</h4> </div>
					</div>
				</div>
				<!-- end page title -->
				<div class="row">
					<div class="col-xl-4">
						<!-- ==================Searching = -->
						<div class="card">
							<div class="card-body">
								<h4 class="card-title mb-4">Pencarian Data</h4>
								<div class="row">
									<form id="form-search">
										<input type="hidden" name="page" value="1">
										<div class="row mb-3">
											<label for="cari_id" class="col-sm-4 col-form-label">ID penjualan</label>
											<div class="col-sm-8">
												<input type="text" class="form-control" id="cari_id" name="cari_id" placeholder="Tulis ID penjualan" value="<%=query.cari_id%>"> </div>
										</div>
										<div class="row mb-3">
											<label for="cari_nama" class="col-sm-4 col-form-label">Nama penjualan</label>
											<div class="col-sm-8">
												<input type="text" class="form-control" id="cari_nama" name="cari_nama" placeholder="Tulis Nama penjualan" value="<%=query.cari_nama%>"> </div>
										</div>
										<div class="card-footer">
											<div class="row">
												<div class="col-sm-4">
													<div class="text-sm-left">
														<button type="submit" class="btn btn-primary">Cari</button> <a href="/penjualan" class="btn btn-warning">Reset</a> </div>
												</div>
												<div class="col-sm-8">
													<ul class="pagination pagination-rounded justify-content-end">
														<button id="start-button" type="button" class="btn btn-primary waves-effect waves-light" data-bs-toggle="modal" data-bs-target=".bs-example-modal-xl"><i class="fa-solid fa-plus"></i> Transaksi Baru</button>
														<div class="modal fade bs-example-modal-xl" tabindex="-1" data-bs-backdrop="static" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
															<div class="modal-dialog modal-xl modal-dialog-scrollable">
																<div class="modal-content">
																	<div class="modal-header">
																		<h5 class="modal-title">Tambah Transaksi Penjualan</h5>
																		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
																	</div>
																	<div class="modal-body">
																		<div class="card-body">
																			<form id="start-form" class="needs-validation" novalidate>
																				<div class="row">
																					<div class="col-md-6">
																						<div class="mb-3">
																							<label for="no_invoice" class="form-label">No Invoice</label>
																							<input type="text" class="form-control" id="no_invoice" placeholder="No Invoice" readonly>
																							<div class="valid-feedback"> Looks good! </div>
																						</div>
																					</div>
																					<div class="col-md-6">
																						<div class="mb-3">
																							<label for="tanggal" class="form-label">Waktu</label>
																							<input type="text" class="form-control" id="tanggal" placeholder="Waktu" readonly>
																							<div class="valid-feedback"> Looks good! </div>
																						</div>
																					</div>
																				</div>
																			</form>
																		</div>
																		<hr class="border border-dark">
																		<div class="card-body">
																			<form id="detail-form" class="needs-validation" novalidate>
																				<div class="row">
																					<div class="col-md-10">
																						<div class="mb-3">
																							<label for="id_item" class="form-label">ID Barang & Item</label>
																							<select class="form-select" name="id_item" id="id_item" required>
																								<option disabled selected>Pilih Barang & Item</option>
																								<% varian.forEach((item)=> { %>
																									<option value="<%= item.id_varian %>">
																										<%= item.id_barang %> - <%= item.nama_barang %> | <%= item.id_varian %> - <%= item.nama_varian %>
																									</option>
																									<% }) %>
																							</select>
																						</div>
																					</div>
																					<div class="col-md-2">
																						<div class="mb-3">
																							<label for="stok" class="form-label">Stok Tersisa</label>
																							<input type="text" class="form-control" id="stok" placeholder="Stok Tersisa" readonly>
																							<div class="invalid-feedback"> Tolong Isi Yang Benar </div>
																						</div>
																					</div>
																				</div>
																				
																				<div class="row">
																					<div class="col-md-6">
																						<div class="mb-3">
																							<label for="nama_barang" class="form-label">Nama Barang</label>
																							<input type="text" class="form-control" id="nama_barang" placeholder="Nama Barang" readonly>
																						</div>
																					</div>
																					<div class="col-md-6">
																						<div class="mb-3">
																							<label for="nama_varian" class="form-label">Nama Varian</label>
																							<input type="text" class="form-control" id="nama_varian" placeholder="Nama Varian" readonly>
																						</div>
																					</div>
																				</div>
																				<div class="row">
																					<div class="col-md-4">
																						<div class="mb-3">
																							<label for="harga_jual" class="form-label">Harga Item</label>
																							<input type="text" class="form-control" id="harga_jual" placeholder="Tulis Harga Item" readonly>
																						</div>
																					</div>
																					<div class="col-md-4">
																						<div class="mb-3">
																							<label for="qty" class="form-label">Qty</label>
																							<input type="text" class="form-control" id="qty" placeholder="Tulis Qty" required>
																							<div class="invalid-feedback"> Tolong Isi Yang Benar </div>
																						</div>
																					</div>
																					<div class="col-md-4">
																						<div class="mb-3">
																							<label for="total_harga_item" class="form-label">Total Harga</label>
																							<input type="text" class="form-control" id="total_harga_item" placeholder="Tulis Total Harga" readonly>
																						</div>
																					</div>
																				</div>
																				<div>
																					<button class="btn btn-primary" type="submit">Tambah</button>
																				</div>
																			</form>
																		</div>
																		<hr class="border border-dark">
																		<div class="card-body">
																			<div class="table-responsive">
																				<h4 class="card-title mb-5">Tabel Detail Penjualan <a href="#" class="text-danger"></a></h4>
																				<table id="detail-table" class="table align-middle table-nowrap table-bordered">
																					<thead class="table-light">
																						<tr class="info">
																							<th class="align-middle">No</th>
																							<th class="align-middle">ID Varian</th>
                                                                                            <th class="align-middle">Nama Varian</th>
																							<th class="align-middle">QTY</th>
																							<th class="align-middle">Harga</th>
																							<th class="align-middle">Total Harga</th>
																						</tr>
																					</thead>
																						<tbody>
																							
																						</tbody>
																				</table>
																			</div>
																		</div>
																		<hr class="border border-dark">
																		<div class="card-body">
																			<form id="jual-form">
																				<div class="row">
																					<div class="col-md-4">
																						<div class="mb-3">
																							<label for="total_harga" class="form-label">Total Harga</label>
																							<input type="text" class="form-control" id="total_harga" placeholder="Total Harga" value="<%= penjualan.total_harga_jual %>" readonly>
																						</div>
																					</div>
																					<div class="col-md-4">
																						<div class="mb-3">
																							<label for="total_bayar" class="form-label">Total Bayar</label>
																							<input type="number" class="form-control" id="total_bayar" placeholder="Total Bayar" required>
																						</div>
																					</div>
																					<div class="col-md-4">
																						<div class="mb-3">
																							<label for="kembalian" class="form-label">Kembalian</label>
																							<input type="text" class="form-control" id="kembalian" placeholder="Kembalian" readonly>
																						</div>
																					</div>
																				</div>
																				<div class="form-check mb-3">
																					<input class="form-check-input" type="checkbox" value="" id="invalidCheck" required>
																					<label class="form-check-label" for="invalidCheck"> Data Telah Benar </label>
																					<div class="invalid-feedback"> Data Harus Benar </div>
																				</div>
																				<div>
																					<button class="btn btn-primary" type="submit">Selesai</button>
																				</div>
																			</form>
																		</div>
																	</div>
																	<div class="modal-footer" style="text-align: center;">
																		<div class="col-12"> -->> Pastikan Telah Data Benar Dan Sesuai <<-- </div>
																		</div>
																	</div>
																	<!-- /.modal-content -->
																</div>
																<!-- /.modal-dialog -->
															</div>
															<!-- /.modal -->
													</ul>
													</div>
													<!-- end col-->
												</div>
											</div>
									</form>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-8">
							<div class="card">
								<div class="card-body">
									<div class="table-responsive">
										<h4 class="card-title mb-5">Tabel Data Penjualan</h4>
										<table id="penjualan-table" class="table table-condensed table-bordered table-striped">
											<thead class="table-light">
												<tr>
													<th class="align-middle">No</th>
													<th class="align-middle">No. Invoice</th>
													<th class="align-middle">Tanggal Penjualan</th>
													<th class="align-middle">Total Harga</th>
													<th class="align-middle">Total Bayar</th>
													<th class="align-middle">Kembalian</th>
													<th class="align-middle">Actions</th>
												</tr>
											</thead>
											<tbody id="invoice-table">
												
											</tbody>
										</table>
									</div>
								</div>
							</div>
							<div class="card">
								<div class="card-body">
									<div class="table-responsive">
										<h4 class="card-title mb-5">Tabel Detail Penjualan <a href="#" class="text-danger">
                                            <%=query.noInvoice%>
                                        </a></h4>
										<table class="table align-middle table-nowrap table-bordered">
											<thead class="table-light">
												<tr class="info">
													<th class="align-middle">No</th>
                                                    <th class="align-middle">ID Varian</th>
													<th class="align-middle">Nama Varian</th>
													<th class="align-middle">QTY</th>
													<th class="align-middle">Harga</th>
													<th class="align-middle">Total Harga</th>
												</tr>
											</thead>
											<% detailsj.forEach((item, index)=> { %>
												<tbody>
													<tr>
														<td>
															<%=index + 1%>
														</td>
                                                        <td>
															<%=item.id_varian%>
														</td>
														<td>
															<%=item.nama_varian%>
														</td>
														<td>
															<%=item.qty%>
														</td>
														<td>
															<%= currencyFormatter.format(item.harga_detail_jual) %>
														</td>
														<td>
															<%= currencyFormatter.format(item.total_harga_detail_jual) %>
														</td>
													</tr>
												</tbody>
												<% }) %>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- end row -->
				</div>
				<!-- container-fluid -->
			</div>
			<!-- End Page-content -->
		</div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
        <script>
            let no_invoice = '<%= penjualan.no_invoice %>';
            //let no_invoice = null;



			const removeData = (no_invoice) => {
            $.ajax({
                method: "DELETE",
                url: `/penjualan/delete/${no_invoice}`,
                dataType: "json"
            }).done(function (response) {
                readData()
            }).fail(function (err) {
                alert('gagal pakai jquery')
            })
        	}

            $(document).ready(function () {
                readDetails()
				readData()
				
                $('#start-button').click(function () {
                    //e.preventDefault();
                    $.post('/penjualan/create').done(function(data){
                        no_invoice = data.no_invoice
                        $('#no_invoice').val(no_invoice)
                        $('#tanggal').val(moment(data.tanggal_penjualan).format('DD MMM YYYY HH:mm:ss'))
                    })
                })


                $('#id_item').change(function () {
                    const id_varian = $(this).val()
                    $.get(`/penjualan/barang/${id_varian}`).done(function (data) {
                        $('#nama_barang').val(data.nama_barang)
                        $('#nama_varian').val(data.nama_varian)
                        $('#harga_jual').val(data.harga_jual_varian)
						$('#stok').val(data.stok_varian)
                        $('#qty').val(1)
                        $('#total_harga_item').val(data.harga_jual_varian)
                    })
                })

                $('#qty').keyup(function () {
                    const qty = $(this).val()
                    const harga_jual = $('#harga_jual').val()
                    $('#total_harga_item').val(harga_jual * qty)
                })
    
                $('#total_bayar').keyup(function () {
                    const total_bayar = $(this).val()
                    const total_harga = $('#total_harga').val()
                    $('#kembalian').val((total_bayar - total_harga))
                })
    
                $('#detail-form').submit(function (e) {
                    e.preventDefault();
                    const no_invoice = $('#no_invoice').val()
                    const id_varian = $('#id_item').val()
                    const qty = $('#qty').val()
                    
                    $.post('/penjualan/additem', { no_invoice, id_varian, qty }).done(function (data) {
                        readDetails()
                        //$('#total_harga').val(currencyFormatter.format(data.total_harga_jual))
                        //console.log(no_invoice, id_varian, qty)
                        $('#total_harga').val(data.total_harga_jual)
                    })
                })

                $('#jual-form').submit(function () {
                    //e.preventDefault();
                    const no_invoice = $('#no_invoice').val()
                    const total_bayar_jual = $('#total_bayar').val()
                    const kembalian = $('#kembalian').val()
                    $.post('/penjualan/upjual', {total_bayar_jual, kembalian, no_invoice}).done(function (data) {
                        //res.redirect('/utama')
                    })
                })
            })

			const readData = () => {
                // $.get(`/penjualan/details/${params}`)
				$.ajax({
                method: "GET",
                url: '/http://localhost:3000/penjualan',
                dataType: "json",
            	}).done(function (data) {
					console.log(data)
                    let html = ''
                    data.forEach((item, index) => {
                        html1 += `
                        <tr>
                            <td>
                                ${index + 1}
                            </td>
                            <td>
                                <a href="/penjualan?noInvoice=${item.no_invoice}">${item.no_invoice}</a>}
                            </td>
                            <td>
                                ${moment(item.tanggal_penjualan).format('DD MMM YYYY HH:SS')}
                            </td>
                            <td class="right-position">
                                ${currencyFormatter.format(item.total_harga_jual)}
                            </td>
                            <td class="right-position">
                                ${currencyFormatter.format(item.total_bayar_jual)}
                            </td>
                            <td class="right-position">
                                ${currencyFormatter.format(item.kembalian_jual)}
                            </td>
							<td>
								<div class="d-flex gap-3"> 
									<a href="/penjualan/show/${item.no_invoice}" class="text-primary"><i class="fa-solid fa-print"></i></a>
									<a href="/penjualan/show/${item.no_invoice}" id="edit-button" type="button" class="text-success waves-effect waves-light" data-bs-toggle="modal" data-bs-target=".bs-example-modal-xl"><i class="fa-solid fa-pencil"></i></a>
									<a href="javascript:void(0)" onclick="removeData('${item.no_invoice}')" class="text-danger"><i class="fa-solid fa-trash"></i></a>
								</div>
							</td>
                        </tr>
                        `
                    })
                    $('#invoice-table').html(html1)
                })
            }


    
            const readDetails = () => {
                // $.get(`/penjualan/details/${params}`)
				$.ajax({
                method: "GET",
                url: `/penjualan/details/${no_invoice}`,
                dataType: "json",
            	}).done(function (data) {
                    let html = ''
                    data.forEach((item, index) => {
                        html += `
                        <tr>
                            <td>
                                ${index + 1}
                            </td>
                            <td>
                                ${item.id_varian}
                            </td>
                            <td>
                                ${item.nama_varian}
                            </td>
                            <td class="right-position">
                                ${item.qty}
                            </td>
                            <td class="right-position">
                                ${currencyFormatter.format(item.harga_detail_jual)}
                            </td>
                            <td class="right-position">
                                ${currencyFormatter.format(item.total_harga_detail_jual)}
                            </td>
                        </tr>
                        `
                    })
                    $('#detail-table tbody').html(html)
                })
            }
        </script>
		<!-- end main content-->
		<%- include('../partials/footer') %>